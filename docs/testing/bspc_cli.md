# BSPC CLI regression checks

The reconstructed `bspc` binary ships with placeholder pipelines that mirror
the control-flow of the historical tool. The script at
`tools/bspc/run_cli_modes.py` exercises every CLI mode against lightweight
fixtures so that automated pipelines can detect argument parsing or filesystem
regressions quickly.

## Running the smoke test

1. Build the `bspc` executable (`ninja bspc` from your CMake build directory).
2. Execute the harness:

   ```bash
   python tools/bspc/run_cli_modes.py --bspc /path/to/build/tools/bspc/bspc
   ```

   The script emits a JSON summary that records the command line for each mode,
the detected timing messages, and the artifacts that were validated. The
workspace defaults to `build/test-output/bspc_cli/` and is recreated for every
run.

### Expected outputs and timing summaries

Each mode asserts that stdout includes a message matching the legacy
`"%5.0f seconds elapsed"` format. The placeholders generated by the pipelines
are compared byte-for-byte against the following expectations:

| Mode     | Inputs                                     | Required outputs |
|----------|--------------------------------------------|------------------|
| map2bsp  | `tests/support/assets/bspc/simple_room.map` | `.bsp`, `.prt`, `.lin` placeholders |
| map2aas  | `tests/support/assets/bspc/simple_room.map` | `.aas`, `.bsp`, `.prt`, `.lin` placeholders |
| bsp2map  | `dev_tools/assets/maps/2box4.bsp`           | No files (logging only) |
| bsp2bsp  | `dev_tools/assets/maps/2box4.bsp`           | `.bsp`, `.prt`, `.lin` placeholders |
| bsp2aas  | `dev_tools/assets/maps/2box4.bsp`           | `.aas` placeholder |

The text content of each generated file captures the source asset path (for
example, `placeholder BSP generated from ...`), making it easy to spot missing
path normalisation in test output.

## Comparing outputs to golden baselines

When the real compilers are reintroduced, you can compare generated files with
known-good baselines using standard binary-safe tools:

```bash
diff -u baseline/maps/test.bsp build/test-output/bspc_cli/map2bsp/test.bsp
cmp baseline/maps/test.bsp build/test-output/bspc_cli/map2bsp/test.bsp
```

For large batches, the `tools/bspc/run_cli_modes.py` harness can emit a JSON
report (`--json report.json`). Feed that summary into a custom comparer that
loads each `artifacts` entry, or adapt the snippet below:

```python
import filecmp
import json
from pathlib import Path

report = json.loads(Path("report.json").read_text())
for entry in report:
    for artifact in entry["artifacts"]:
        generated = Path("build/test-output/bspc_cli") / entry["flag"] / artifact
        baseline = Path("baseline") / entry["flag"] / artifact
        if not filecmp.cmp(generated, baseline, shallow=False):
            raise SystemExit(f"Mismatch detected for {entry['flag']}:{artifact}")
```

This approach keeps baseline comparisons close to the scripted smoke test and
avoids duplicating path logic.
